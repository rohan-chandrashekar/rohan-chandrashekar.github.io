---
import { profile } from '../lib/constants/profile';
import ThemeToggle from './ThemeToggle';

const items = [
  { href: '/', label: 'Home' },
  { href: '/about/', label: 'About' },
  { href: '/projects/', label: 'Projects' },
  { href: '/research/', label: 'Research' },
  { href: '/activities/', label: 'Activities' },
  { href: '/resume/', label: 'Resume' }
];

const pathname = Astro.url.pathname;
const isActive = (href) => {
  if (href === '/') return pathname === '/';
  return pathname.startsWith(href);
};

const desktopActiveClass = 'rounded-full bg-slate-900 dark:bg-slate-100 px-3 py-2 text-sm font-semibold text-white dark:text-slate-900 shadow-soft';
const desktopInactiveClass = 'rounded-full px-3 py-2 text-sm text-slate-700 dark:text-slate-300 transition hover:bg-slate-100 dark:bg-slate-900 dark:bg-slate-100/50 hover:text-slate-900 dark:text-slate-50';
const mobileActiveClass = 'shrink-0 rounded-full bg-slate-900 dark:bg-slate-100 px-3 py-1.5 text-xs font-semibold text-white dark:text-slate-900 shadow-soft';
const mobileInactiveClass = 'shrink-0 rounded-full border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-950/80 dark:bg-slate-950/80 px-3 py-1.5 text-xs font-semibold text-slate-800 dark:text-slate-200';
---

<header transition:persist class="fixed top-0 left-0 right-0 z-50">
  <div class="mx-auto max-w-6xl px-4 pt-3">
    <div class="pointer-events-auto overflow-hidden rounded-3xl border border-slate-200 dark:border-slate-800/60 bg-white dark:bg-slate-950/70 dark:bg-slate-950/70 shadow-[0_25px_70px_rgba(16,24,40,0.10)] backdrop-blur">
      <nav class="flex items-center justify-between gap-3 px-3 py-2 sm:px-4">
        <a href="/" class="group flex items-center gap-2">
          <div class="h-9 w-9 rounded-xl bg-gradient-to-br from-sky-400 via-violet-400 to-emerald-400 p-[1px]">
            <img
              src="/images/profile.jpg"
              alt="Rohan Chandrashekar"
              class="h-10 w-10 rounded-full object-cover ring-1 ring-slate-900/10 dark:ring-white/10"
            />
          </div>
          <div class="max-w-[170px] leading-tight">
            <div class="text-sm font-semibold text-slate-900 dark:text-slate-50 whitespace-normal break-words">{profile.name}</div>
          </div>
        </a>

        <div class="hidden items-center gap-1 md:flex">
          {items.map((i) => (
            <a
              href={i.href}
              data-nav-link="true"
              data-href={i.href}
              data-active-class={desktopActiveClass}
              data-inactive-class={desktopInactiveClass}
              aria-current={isActive(i.href) ? 'page' : undefined}
              class={isActive(i.href) ? desktopActiveClass : desktopInactiveClass}
            >
              {i.label}
            </a>
          ))}
        </div>

        <div class="flex items-center gap-2">
          <div class="flex items-center gap-1">
            <a
              class="inline-flex items-center justify-center rounded-full border border-slate-200 bg-white/70 p-2 text-slate-700 shadow-[0_18px_45px_rgba(16,24,40,0.06)] backdrop-blur transition hover:text-slate-900 dark:border-slate-800/60 dark:bg-slate-950/40 dark:text-slate-200 dark:hover:text-slate-50"
              href={profile.links.linkedin}
              target="_blank"
              rel="noreferrer"
              aria-label="LinkedIn"
              title="LinkedIn"
            >
              <svg viewBox="0 0 24 24" class="h-5 w-5" fill="currentColor" aria-hidden="true">
                <path d="M4.98 3.5C4.98 4.88 3.87 6 2.5 6S0 4.88 0 3.5 1.11 1 2.48 1c1.38 0 2.5 1.12 2.5 2.5zM.5 23.5h4V7.98h-4V23.5zM8.5 7.98h3.83v2.12h.05c.53-1 1.83-2.12 3.77-2.12 4.03 0 4.78 2.65 4.78 6.1v9.42h-4v-8.35c0-1.99-.04-4.55-2.77-4.55-2.77 0-3.19 2.16-3.19 4.4v8.5h-4V7.98z"/>
              </svg>
            </a>

            <a
              class="inline-flex items-center justify-center rounded-full border border-slate-200 bg-white/70 p-2 text-slate-700 shadow-[0_18px_45px_rgba(16,24,40,0.06)] backdrop-blur transition hover:text-slate-900 dark:border-slate-800/60 dark:bg-slate-950/40 dark:text-slate-200 dark:hover:text-slate-50"
              href={profile.links.github}
              target="_blank"
              rel="noreferrer"
              aria-label="GitHub"
              title="GitHub"
            >
              <svg viewBox="0 0 24 24" class="h-5 w-5" fill="currentColor" aria-hidden="true">
                <path d="M12 0.297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385 0.6 0.113 0.82-0.258 0.82-0.577 0-0.285-0.01-1.04-0.015-2.04 -3.338 0.724-4.042-1.61-4.042-1.61 -0.546-1.387-1.333-1.756-1.333-1.756 -1.09-0.745 0.083-0.73 0.083-0.73 1.205 0.085 1.84 1.24 1.84 1.24 1.07 1.835 2.807 1.305 3.492 0.998 0.108-0.776 0.417-1.305 0.76-1.605 -2.665-0.3-5.466-1.332-5.466-5.93 0-1.31 0.468-2.38 1.236-3.22 -0.123-0.303-0.536-1.523 0.117-3.176 0 0 1.008-0.322 3.3 1.23 0.957-0.266 1.983-0.399 3.003-0.404 1.02 0.005 2.047 0.138 3.006 0.404 2.29-1.552 3.297-1.23 3.297-1.23 0.655 1.653 0.242 2.873 0.12 3.176 0.77 0.84 1.235 1.91 1.235 3.22 0 4.61-2.807 5.625-5.48 5.92 0.43 0.37 0.823 1.103 0.823 2.222 0 1.606-0.015 2.898-0.015 3.293 0 0.32 0.216 0.694 0.825 0.576 4.765-1.58 8.2-6.08 8.2-11.38 0-6.627-5.373-12-12-12z"/>
              </svg>
            </a>

            <a
              class="inline-flex items-center justify-center rounded-full border border-slate-200 bg-white/70 p-2 text-slate-700 shadow-[0_18px_45px_rgba(16,24,40,0.06)] backdrop-blur transition hover:text-slate-900 dark:border-slate-800/60 dark:bg-slate-950/40 dark:text-slate-200 dark:hover:text-slate-50"
              href={profile.links.handshake}
              target="_blank"
              rel="noreferrer"
              aria-label="Handshake"
              title="Handshake"
            >
              <svg viewBox="0 0 24 24" class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <path d="M7 4v16" />
                <path d="M17 4v16" />
                <path d="M7 12h10" />
              </svg>
            </a>
          </div>

          <ThemeToggle client:load />
        </div>
      </nav>

      <div class="md:hidden">
        <div class="no-scrollbar flex gap-2 overflow-x-auto px-3 pb-2">
          {items.map((i) => (
            <a
              href={i.href}
              data-nav-link="true"
              data-href={i.href}
              data-active-class={mobileActiveClass}
              data-inactive-class={mobileInactiveClass}
              aria-current={isActive(i.href) ? 'page' : undefined}
              class={isActive(i.href) ? mobileActiveClass : mobileInactiveClass}
            >
              {i.label}
            </a>
          ))}
        </div>
      </div>

      <div class="h-px bg-gradient-to-r from-transparent via-slate-200/80 dark:via-slate-800/80 to-transparent" />
      <div class="relative h-[3px] bg-slate-100 dark:bg-slate-900 dark:bg-slate-100/50">
        <div id="scrollbar" class="h-full w-full origin-left scale-x-0 bg-gradient-to-r from-slate-900 dark:from-slate-100 via-slate-700 dark:via-slate-300 to-transparent" />
      </div>
    </div>
  </div>

  <script is:inline>
    (function () {
      const bar = document.getElementById('scrollbar');
      if (!bar) return;

      const clamp = (n, min, max) => Math.max(min, Math.min(max, n));
      const update = () => {
        const el = document.documentElement;
        const h = el.scrollHeight - el.clientHeight;
        const p = h > 0 ? el.scrollTop / h : 0;
        bar.style.transform = `scaleX(${clamp(p, 0, 1)})`;
      };

      document.addEventListener('scroll', update, { passive: true });
      update();
    })();
  </script>
<script is:inline>
  (() => {
    const normalize = (p) => (p === '/' ? '/' : (p.endsWith('/') ? p : p + '/'));
    const isActiveHref = (href, pathname) => {
      if (href === '/') return pathname === '/';
      return pathname.startsWith(href);
    };

    const updateActiveNav = () => {
      const pathname = normalize(window.location.pathname || '/');
      document.querySelectorAll('[data-nav-link="true"]').forEach((el) => {
        const href = el.getAttribute('data-href') || '/';
        const active = isActiveHref(href, pathname);
        const activeClass = el.getAttribute('data-active-class') || el.className;
        const inactiveClass = el.getAttribute('data-inactive-class') || el.className;

        el.className = active ? activeClass : inactiveClass;
        if (active) el.setAttribute('aria-current', 'page');
        else el.removeAttribute('aria-current');
      });
    };

    document.addEventListener('astro:page-load', updateActiveNav);
    document.addEventListener('astro:after-swap', updateActiveNav);
    // Fallback for non-transition navigations
    window.addEventListener('popstate', updateActiveNav);

    updateActiveNav();
  })();
</script>
</header>
